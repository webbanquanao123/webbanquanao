USE master
IF EXISTS(SELECT * FROM sys.databases WHERE name='QL_QUANAO')
BEGIN
        DROP DATABASE QL_QUANAO
END
CREATE DATABASE QL_QUANAO
GO
USE QL_QUANAO
GO

CREATE TABLE NCC 
(
    MANCC INT IDENTITY NOT NULL,
    TENNCC NVARCHAR(50), -- TÊN CÁC NHÓM QUYỀN(ADIMIN,NHÂN VIÊN)
    CONSTRAINT PK_NCC PRIMARY KEY (MANCC) --KHÓA CHÍNH
	
)

CREATE TABLE QUYEN 
(
    MAQUYEN INT IDENTITY NOT NULL,
    TENQUYEN NVARCHAR(50), -- TÊN CÁC NHÓM QUYỀN(ADIMIN,NHÂN VIÊN)
    CONSTRAINT PK_QUYEN PRIMARY KEY (MAQUYEN) --KHÓA CHÍNH
)
CREATE TABLE TAIKHOAN 
(
    TENTK VARCHAR(50) not null,
	MATKHAU CHAR(50),
    MAQUYEN INT ,
	--KHÓA CHÍNH
	CONSTRAINT PK_TAIKHOAN PRIMARY KEY (TENTK),
	--KHÓA NGOẠI
	CONSTRAINT FK_TK_QUYEN FOREIGN KEY(MAQUYEN) REFERENCES QUYEN(MAQUYEN)
)
CREATE TABLE THONGTINTAIKHOAN 
(
	TENTK VARCHAR(50) NOT NULL, 
    HOTEN NVARCHAR(50), -- HỌ TÊN
    NGSINH DATE, -- NGÀY SINH
    GTINH NVARCHAR(3),
    NGTAO DATETIME, -- NGÀY TẠO
    EMAIL VARCHAR(50), -- ĐỊA CHỈ EMAIL
    SDT VARCHAR(11), -- SDT
    DCHI NVARCHAR(50), -- ĐỊA CHỈ NHÀ
	--KHÓA CHÍNH
    CONSTRAINT PK_TTTK PRIMARY KEY (TENTK),
	--KHÓA NGOẠI
	CONSTRAINT FK_TTTK_TAIKHOAN FOREIGN KEY(TENTK) REFERENCES TAIKHOAN(TENTK)
)

CREATE TABLE LOAISP 
(
    MALSP VARCHAR(6) NOT NULL,
    TENLOAI NVARCHAR(50),
    CONSTRAINT PK_LSP PRIMARY KEY (MALSP)
)

CREATE TABLE SANPHAM 
(
    MASP INT IDENTITY NOT NULL, -- CREATE AUTO
    TENSP NVARCHAR(MAX), -- TÊN SẢN PHẨM
    SIZE VARCHAR(3), -- KÍCH THƯỚC
    SOLUONG INT, -- SỐ LƯỢNG TỒN KHO
    DONGIA FLOAT, -- ĐƠN GIÁ
	HINHANH NVARCHAR(20),
    MALSP VARCHAR(6) REFERENCES LOAISP(MALSP),
    CONSTRAINT PK_SP PRIMARY KEY (MASP)
)
CREATE TABLE NHAPHANG 
(
    MANHAP INT IDENTITY NOT NULL,
    MASP int , -- TÊN CÁC NHÓM QUYỀN(ADIMIN,NHÂN VIÊN)
	MANCC int,
	SL int,
	NGNHAP Datetime,
	DONGIANHAP int,
    CONSTRAINT PK_NHAPHANG PRIMARY KEY (MANHAP), --KHÓA CHÍNH
	CONSTRAINT FK_NH_SP FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP),
	CONSTRAINT FK_NV_NCC FOREIGN KEY(MANCC) REFERENCES NCC(MANCC)
)

CREATE TABLE KHUYENMAI 
(
    MAKM VARCHAR(20) NOT NULL, -- CREATE AUTO
    TENKM VARCHAR(30), -- NGÀY TẠO HÓA ĐƠN
    GIAMGIA int  -- TỔNG (SỐ LƯỢNG * ĐƠN GIÁ)
    CONSTRAINT PK_KM PRIMARY KEY (MAKM)
)

CREATE TABLE HOADON 
(
    MAHD INT IDENTITY NOT NULL, -- CREATE AUTO
    NGTAO DATETIME, -- NGÀY TẠO HÓA ĐƠN
    THANHTOAN FLOAT, -- TỔNG (SỐ LƯỢNG * ĐƠN GIÁ)
    MAKM VARCHAR(20) REFERENCES KHUYENMAI(MAKM),
    CONSTRAINT PK_HD PRIMARY KEY (MAHD)
)
CREATE TABLE CHITIETHD 
(
    MAHD INT REFERENCES HOADON(MAHD),
    MASP INT REFERENCES SANPHAM(MASP),
    SOLUONG INT, -- SỐ LƯỢNG > 0, số lượng bán
    CONSTRAINT PK_CTHD PRIMARY KEY (MAHD,MASP) 
)

CREATE TABLE DOITRA 
(
    MAHD INT REFERENCES HOADON(MAHD),
    MASP INT REFERENCES SANPHAM(MASP),
	TENTK VARCHAR(50),
	NGDOI datetime,
	LYDO nvarchar(Max),
	TinhTrang nvarchar(20), -- ĐỒNG Ý ĐỔI , TỪ CHỐI ĐỔI
    CONSTRAINT PK_DOITRA PRIMARY KEY (MAHD,MASP),
	CONSTRAINT FK_DOITRA_TAIKHOAN FOREIGN KEY(TENTK) REFERENCES TAIKHOAN(TENTK)
)

----------------------------------------------------------------------------
--RÀNG BUỘC TOÀN VẸN
----------------------------------------------------------------------------
SET DATEFORMAT DMY

--TABLE TAIKHOAN
ALTER TABLE TAIKHOAN ADD CONSTRAINT uni_TenLoaiTK UNIQUE(TENTK)
GO

--TABLE THONGTINTAIKHOAN
ALTER TABLE THONGTINTAIKHOAN ADD CONSTRAINT chk_GioiTinh CHECK(GTINH IN (N'Nam', N'Nữ'))
ALTER TABLE THONGTINTAIKHOAN ADD CONSTRAINT DEF_DC DEFAULT N'TP.HCM' FOR DCHI
GO

----TABLE KHACHHANG
--ALTER TABLE KHACHHANG ADD CONSTRAINT chk_SDT_KH CHECK(LEN(MAKH)=10)
--ALTER TABLE KHACHHANG ADD CONSTRAINT chk_PhanTramGiam CHECK(DIEMTICHLUY>=0 AND DIEMTICHLUY<=50)
--GO

--TABLE HOADON
ALTER TABLE CHITIETHD ADD CONSTRAINT chk_SoLuong_CTHD CHECK(SOLUONG>0)
ALTER TABLE HOADON ADD CONSTRAINT chk_ThanhTien_HD CHECK(THANHTOAN>0)
GO

----TABLE DANH MUC
--ALTER TABLE DANHMUC ADD CONSTRAINT uni_TenDanhMuc UNIQUE(TENDANHMUC)
--GO

--TABLE SANPHAM

ALTER TABLE SANPHAM ADD CONSTRAINT chk_GiaBan CHECK(DONGIA>0)
GO

--Ràng buộc trigger

--Cập nhật thanh toán trên hóa đơn
--CREATE TRIGGER CAPNHATTHANHTOAN
--ON CHITIETHD
--FOR INSERT,UPDATE,DELETE
--AS
--	BEGIN
--	DECLARE @GiamGia MONEY
	
--	-- cập nhật số lượng tồn của sản phẩm khi thêm vào 1 CHITIETHD
--		UPDATE SANPHAM
--		SET SOLUONG = SOLUONG - (SELECT SOLUONG FROM inserted)
--				WHERE MASP = (SELECT MASP FROM inserted)
--	----cập nhật TỔNG TIỀN sau khi trừ đi ĐIỂM TÍCH LŨY cho KHACHHANG (1 điểm được 2000)
--	--IF((SELECT DIEMTICHLUY FROM KHACHHANG,HOADON WHERE HOADON.MAKH=KHACHHANG.MAKH AND MAHD =(SELECT MAHD FROM inserted))>0)
--	--BEGIN
--	--	SET @GiamGia = (SELECT DIEMTICHLUY FROM KHACHHANG,HOADON WHERE HOADON.MAKH=KHACHHANG.MAKH AND MAHD =(SELECT MAHD FROM inserted))*2000
--	---- cập nhật TỔNG TIỀN thu được của mỗi CHITIETHD
--		UPDATE HOADON
--		SET THANHTOAN = (SELECT SUM(CHITIETHD.SOLUONG*SANPHAM.DONGIA)
--						FROM CHITIETHD,SANPHAM
--						WHERE CHITIETHD.MASP = SANPHAM.MASP AND CHITIETHD.MAHD =(SELECT MAHD FROM inserted) GROUP BY CHITIETHD.MAHD) - @GiamGia
--		WHERE MAHD =(SELECT MAHD FROM inserted)
--	END
--		ELSE
--		-- cập nhật TỔNG TIỀN thu được của mỗi CHITIETHD
--		UPDATE HOADON
--		SET THANHTOAN = (SELECT SUM(CHITIETHD.SOLUONG*SANPHAM.DONGIA)
--						FROM CHITIETHD,SANPHAM
--						WHERE CHITIETHD.MASP = SANPHAM.MASP AND CHITIETHD.MAHD =(SELECT MAHD FROM inserted) GROUP BY CHITIETHD.MAHD)
--		WHERE MAHD =(SELECT MAHD FROM inserted)
--	END		
--GO

--cập nhật điểm tích lũy khi khách hàng mua sản phẩm trên 500k

--CREATE TRIGGER sp_UpdateDiemTL
--ON HOADON
--AFTER UPDATE
--AS
--	IF((SELECT THANHTOAN FROM HOADON WHERE MAHD =(SELECT MAHD FROM inserted)) > 500000 
--		AND (SELECT TINHTRANG FROM HOADON WHERE MAHD =(SELECT MAHD FROM inserted)) = N'Đã thanh toán')
--	BEGIN
--		UPDATE KHACHHANG 
--		SET DIEMTICHLUY = DIEMTICHLUY + 1
--		WHERE MAKH =(SELECT MAKH FROM inserted)
--	END
--GO


----------------------------------------------------------------------------
--NHẬP DỮ LIỆU
----------------------------------------------------------------------------

--BẢNG NCC
INSERT INTO NCC VALUES ('SWE')
INSERT INTO NCC VALUES ('ALDV')
INSERT INTO NCC VALUES ('TAOBAO')
INSERT INTO NCC VALUES ('ZARA')
INSERT INTO NCC VALUES ('YAME')
INSERT INTO NCC VALUES ('H&M')



--BẢNG QUYỀN
INSERT QUYEN VALUES(N'ADMIN')
INSERT QUYEN VALUES(N'KHÁCH HÀNG')

--BẢNG TÀI KHOẢN


--BẢNG THÔNG TIN TÀI KHOẢN

--BẢNG LOẠI SP
INSERT INTO LOAISP
VALUES
('LSP001', 'Shirts'),
('LSP002', 'Hoodie'),
('LSP003', 'Crop Tops'),
('LSP004', 'Dresses'),
('LSP005', 'Bottoms'),
('LSP006', 'Sets'),
('LSP007', 'Accessories');

----BẢNG SẢN PHẨM
INSERT INTO SANPHAM
VALUES
('Shirt A','L',30, 400000, '1.jpg','LSP001'),
('Shirt B','L',30, 400000, '2.jpg','LSP001'),
('Shirt C','L',30, 400000, '3.jpg','LSP001'),
('Shirt D','L',30, 400000, '4.jpg','LSP001'),
('Shirt E','L',30, 400000, '5.jpg','LSP001'),
('Shirt F','L',30, 400000, '6.jpg','LSP001'),
('Shirt G','L',30, 400000, '7.jpg','LSP001'),
('Shirt H','L',30, 400000, '8.jpg','LSP001'),
('Shirt I','L',30, 400000, '9.jpg','LSP001'),

('Hoodie A', 'L',30, 400000, '10.jpg','LSP002'),
('Hoodie B', 'L',30, 400000, '11.jpg','LSP002'),
('Hoodie C', 'L',30, 400000, '12.jpg','LSP002'),
('Hoodie D', 'L',30, 400000, '13.jpg','LSP002'),
('Hoodie E', 'L',30, 400000, '14.jpg','LSP002'),
('Hoodie F', 'L',30, 400000, '15.jpg','LSP002'),

('Crop top A', 'L',30, 400000, '16.jpg','LSP003'),
('Crop top B', 'L',30, 400000, '17.jpg','LSP003'),
('Crop top C', 'L',30, 400000, '18.jpg','LSP003'),
('Crop top D', 'L',30, 400000, '19.jpg','LSP003'),
('Crop top E', 'L',30, 400000, '20.jpg','LSP003'),
('Crop top F', 'L',30, 400000, '21.jpg','LSP003'),
('Crop top G', 'L',30, 400000, '22.jpg','LSP003'),
('Crop top H', 'L',30, 400000, '23.jpg','LSP003'),
('Crop top I', 'L',30, 400000, '24.jpg','LSP003'),


('Dress A', 'L',30, 400000, '25.jpg','LSP004'),
('Dress B', 'L',30, 400000, '26.jpg','LSP004'),
('Dress C', 'L',30, 400000, '27.jpg','LSP004'),
('Dress D', 'L',30, 400000, '28.jpg','LSP004'),
('Dress E', 'L',30, 400000, '29.jpg','LSP004'),
('Dress F', 'L',30, 400000, '30.jpg','LSP004'),
('Dress G', 'L',30, 400000, '31.jpg','LSP004'),
('Dress H', 'L',30, 400000, '32.jpg','LSP004'),
('Dress I', 'L',30, 400000, '33.jpg','LSP004'),


('Bottom A', 'L',30, 400000, '34.jpg','LSP005'),
('Bottom B', 'L',30, 400000, '35.jpg','LSP005'),
('Bottom C', 'L',30, 400000, '36.jpg','LSP005'),
('Bottom D', 'L',30, 400000, '37.jpg','LSP005'),
('Bottom E', 'L',30, 400000, '38.jpg','LSP005'),
('Bottom F', 'L',30, 400000, '39.jpg','LSP005'),
('Bottom G', 'L',30, 400000, '40.jpg','LSP005'),
('Bottom H', 'L',30, 400000, '41.jpg','LSP005'),
('Bottom I', 'L',30, 400000, '42.jpg','LSP005'),
('Bottom J', 'L',30, 400000, '43.jpg','LSP005'),


('Set A',  'L',30, 400000, '44.jpg','LSP006'),
('Set B',  'L',30, 400000, '45.jpg','LSP006'),
('Set C',  'L',30, 400000, '46.jpg','LSP006'),
('Set D',  'L',30, 400000, '47.jpg','LSP006'),
('Set E',  'L',30, 400000, '48.jpg','LSP006'),
('Set F',  'L',30, 400000, '49.jpg','LSP006'),
('Set G',  'L',30, 400000, '50.jpg','LSP006'),


('Accessories A','L',30, 400000, '51.jpg','LSP007'),
('Accessories B','L',30, 400000, '52.jpg','LSP007'),
('Accessories C','L',30, 400000, '53.jpg','LSP007'),
('Accessories D','L',30, 400000, '54.jpg','LSP007'),
('Accessories E','L',30, 400000, '55.jpg','LSP007'),
('Accessories F','L',30, 400000, '56.jpg','LSP007'),
('Accessories G','L',30, 400000, '57.jpg','LSP007'),
('Accessories H','L',30, 400000, '58.jpg','LSP007'),
('Accessories I','L',30, 400000, '59.jpg','LSP007');

--BẢNG NHẬP HÀNG
set dateformat dmy
INSERT INTO NHAPHANG VALUES (1,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (2,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (3,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (4,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (5,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (6,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (7,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (8,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (9,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (10,1,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (11,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (12,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (13,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (14,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (15,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (16,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (17,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (18,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (19,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (20,2,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (21,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (22,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (23,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (24,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (25,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (26,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (27,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (28,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (29,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (30,3,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (31,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (32,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (33,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (34,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (35,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (36,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (37,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (38,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (39,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (40,4,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (41,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (42,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (43,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (44,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (45,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (46,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (47,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (48,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (49,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (50,5,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (51,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (52,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (53,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (54,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (55,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (56,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (57,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (58,6,78,'21/10/2021',90000)
INSERT INTO NHAPHANG VALUES (59,6,78,'21/10/2021',90000)
--BẢNG KHUYẾN MÃI
INSERT INTO KHUYENMAI VALUES ('SALE10',N'Giảm đầu tháng',10)
INSERT INTO KHUYENMAI VALUES ('SALE20',N'Giảm mua lần đầu',20)
INSERT INTO KHUYENMAI VALUES ('SALE50',N'Giảm sinh nhật',50)

--BẢNG TÀI KHOẢN
INSERT INTO TAIKHOAN VALUES ('lethuyna','17052001',1)
INSERT INTO TAIKHOAN VALUES ('nguyenngocnhung','21102001',2)
INSERT INTO TAIKHOAN VALUES ('vovantin','21122001',1)
INSERT INTO TAIKHOAN VALUES ('trantrongbinhphuong','01012001',2)
INSERT INTO TAIKHOAN VALUES ('dinhphattai','30092001',1)

--BẢNG THÔNG TIN TÀI KHOẢN
INSERT INTO THONGTINTAIKHOAN VALUES('lethuyna',N'Lê Thùy Na','17/05/2001',N'Nữ',null,'nalethuy@gmail.com','0362417182',N'Phú Yên')
INSERT INTO THONGTINTAIKHOAN VALUES('nguyenngocnhung',N'Nguyễn Ngọc Nhung','21/10/2001',N'Nữ',null,null,'0368627640',N'Đồng Nai')
INSERT INTO THONGTINTAIKHOAN VALUES('vovantin',N'Võ Văn Tin','21/12/2001',N'Nam',null,null,'0964848973',N'Gia Lai')
INSERT INTO THONGTINTAIKHOAN VALUES('trantrongbinhphuong',N'Trần Trọng Bình Phương','01/01/2001',N'Nam',null,null,'0372645002',N'Đồng Tháp')
INSERT INTO THONGTINTAIKHOAN VALUES('dinhphattai',N'Đinh Phát Tài','30/09/2001',N'Nam',null,null,'0359975249',N'Long An')